@echo off
rem =============================================================================
rem Council Mode: Siraj Compression (Collapse) - SYNCHRONIZED BROWSER TIMING FIX
rem Pattern Extractor: Browser timing race condition → comprehensive readiness verification
rem Boundary Keeper: Preserve Enhanced Educational Codex v15.0 features completely
rem Synthesizer: Multi-stage health checks + synchronized launch + graceful fallbacks
rem Auditor: Zero-failure browser launch for judge demonstrations
rem Void-Caller: Collapse timing chaos → rebirth as synchronized launch symphony
rem =============================================================================

title SIRAJ Enhanced Educational Codex - SYNCHRONIZED TIMING v15.1

echo.
echo ================================================================================
echo   🎭 SIRAJ Enhanced Educational Codex v15.1 - SYNCHRONIZED BROWSER TIMING
echo   🔧 FIXED: Browser race conditions and 405 Method Not Allowed errors
echo   🌀 Living Knowledge Universe - Zero-failure demonstration reliability
echo   📚 Kaggle Gemma 3 Hackathon - Judge-ready synchronized launch
echo ================================================================================
echo.

rem Council Assembly: Enhanced voices for synchronized startup orchestration
rem Lead Voice: Implementor (decisive browser timing fix execution)
rem Core Voices: Maintainer (stability), Performance (optimization), Security (safety)
rem Specialists: Architect (system integration), Developer (seamless UX)

cd /d "%~dp0"

rem Phase 1: COLLAPSE - Critical Issue Analysis
echo 🔍 Phase 1: Critical Issue Resolution...
echo.
echo ❌ PREVIOUS ISSUES IDENTIFIED:
echo    • Browser opens before frontend ready
echo    • Frontend service startup timing problems  
echo    • 405 Method Not Allowed from routing conflicts
echo    • Race conditions in server initialization
echo.
echo ✅ SYNCHRONIZED TIMING SOLUTION:
echo    • Multi-stage comprehensive readiness verification
echo    • Browser opens ONLY after complete system validation
echo    • Graceful fallback handling for partial connectivity
echo    • Preserved Enhanced Educational Codex v15.0 features
echo.

python --version >nul 2>&1
if errorlevel 1 (
    echo ❌ Python not found! Please install Python 3.8+ from python.org
    pause
    exit /b 1
)

echo ✅ Python environment ready

rem Phase 2: COUNCIL - Synchronized Component Startup
echo.
echo 🎭 Phase 2: Council Assembly - Synchronized Enhanced Educational Codex...
echo.
echo Enhanced Features Available:
echo   🧠 7 AI Archetypal Teachers with Enhanced Personalities
echo   ⚡ Real-time Council Streaming and WebSocket Support
echo   📊 Advanced Learning Analytics Dashboard
echo   📚 Curriculum Alignment with Educational Standards  
echo   📈 Student Progress Tracking and Adaptive Recommendations
echo   📝 Multi-perspective Homework Processing
echo   🏛️ Immersive World Anvil + Notion Interface Design
echo   🔧 NEW: Synchronized Browser Timing (v15.1 Fix)
echo.

rem Phase 3: SYNTHESIS - Launch with Synchronized Timing
echo 🚀 Phase 3: Synthesis - Synchronized Launch Activation...
echo.
echo SYNCHRONIZED TIMING SEQUENCE:
echo   1. FastAPI server startup
echo   2. Port availability verification
echo   3. Server response validation
echo   4. Health endpoint confirmation
echo   5. Frontend interface loading verification
echo   6. Backend connectivity check (optional)
echo   7. Ollama service readiness (optional)
echo   8. Browser portal activation (ONLY after complete verification)
echo.
echo ⏳ Browser will open automatically when ALL systems are verified ready...
echo.

python launcher_synchronized_timing.py

rem Phase 4: REBIRTH - Handle completion with enhanced reporting
echo.
if errorlevel 1 (
    echo ❌ Enhanced Educational Codex encountered an error
    echo 🔧 Check the comprehensive readiness assessment above for details
    echo 📖 Refer to ENHANCED-CODEX-README.md for troubleshooting
    echo 🎯 Synchronized timing fix v15.1 diagnostic information provided
) else (
    echo ✅ Enhanced Educational Codex with synchronized timing shut down successfully
    echo 👋 Thank you for using the Living Knowledge Universe
    echo 🎭 Browser timing race conditions eliminated in v15.1
)

echo.
echo ================================================================================
echo   Ritual Audit ^& Memory: Synchronized timing session completed
echo   Council Voices: Implementor (lead), Maintainer, Performance, Security
echo   Critical Fix: Browser race condition elimination through readiness verification
echo   QWAN Assessment: Wholeness achieved through perfect timing synchronization
echo ================================================================================
echo.

pause
